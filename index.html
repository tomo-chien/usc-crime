<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crime</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; color: #222; background: #fff; }
    h1 { font-size: 30px; font-weight: bold; margin-bottom: 5px; }
    h1 span { color: #ac2124; }
    h2.subheading { font-size: 14px; font-weight: normal; color: #666; margin-bottom: 20px; font-style: italic; }
    .tabs { margin-bottom: 15px; }
    .tab-button { padding: 10px 16px; margin-right: 5px; border: none; background: #ddd; cursor: pointer; border-radius: 6px 6px 0 0; }
    .tab-button.active { background: #ac2124; color: #fff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .filters { margin-bottom: 10px; }
    .filters label { margin-right: 15px; }
    input[type="date"] { padding: 6px; border: 1px solid #ccc; border-radius: 4px; margin-right: 5px; }
    .table-container { overflow-x: auto; max-width: 100%; }
    #searchAll {
      display: block;
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      margin: 0 0 10px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    table { border-collapse: collapse; width: 100%; font-size: 12px; table-layout: fixed; }
    thead { background-color: #ac2124; color: #fff; position: sticky; top: 0; z-index: 2; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: left; white-space: normal; word-wrap: break-word; overflow-wrap: break-word; }
    tr:nth-child(even) { background: #f9f9f9; }
    tbody tr:hover { background: #f1f1f1; }
    #loadMoreAll { display: block; margin: 20px auto; padding: 10px 18px; border: none; background: #ac2124; color: #fff; font-size: 14px; border-radius: 25px; cursor: pointer; }
    #loadMoreAll:hover { background: #800000; transform: scale(1.05); }
    #loadMoreAll:active { transform: scale(0.95); }
    #categoryChart { max-width: 800px; margin: 40px auto 0 auto; }

    /* Advanced resources tab buttons */
    #resources button {
      margin: 5px 10px 10px 0;
      padding: 10px 16px;
      border: none;
      background: #ac2124;
      color: #fff;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
    }
    #resources button:hover {
      background: #800000;
    }

    @media (max-width: 768px) {
      body { 
        margin: 10px; 
        font-size: 14px; 
        overflow-x: hidden; 
      }
      h1 { font-size: 20px; }
      .tab-button { flex: 1; font-size: 14px; padding: 8px; }
      table { font-size: 11px; width: 100%; max-width: 100%; border-collapse: separate; }

      table thead { display: none; }
      table, table tbody, table tr, table td { display: block; width: 100%; max-width: 100%; box-sizing: border-box; }
      table tr { margin-bottom: 16px; padding: 12px 14px; border-radius: 12px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
      table td {
        text-align: left; 
        padding: 6px 0 6px 38%; 
        position: relative; 
        border: none; 
        border-bottom: 1px solid #f0f0f0; 
        font-size: 13px;
        white-space: normal !important;
        word-break: break-word !important;
        overflow-wrap: anywhere !important;
        max-width: 100%;
        box-sizing: border-box;
      }
      table td:last-child { border-bottom: none; }
      table td::before {
        content: attr(data-label); 
        position: absolute; 
        left: 10px; 
        top: 6px; 
        font-weight: 600; 
        color: #555; 
        font-size: 12px; 
        text-transform: uppercase; 
        letter-spacing: 0.5px;
        width: 35%; 
        max-width: 35%; 
        display: inline-block;
        box-sizing: border-box;
        overflow-wrap: break-word;
      }
      #searchAll {
        position: sticky;
        top: 0;
        z-index: 10;
        background: #fff;
      }
      #loadMoreAll {
        width: 100%;
        font-size: 13px;
        padding: 10px;
        border-radius: 8px;
      }
    }
  </style>
</head>
<body>
  <h1>tomo.news/<span>crime</span></h1>
  <h2 class="subheading">From the creator of Morning, Trojan</h2>

  <div class="tabs">
    <button class="tab-button active" data-tab="allLogs">All incidents</button>
    <button class="tab-button" data-tab="dashboard">Dashboard</button>
    <button class="tab-button" data-tab="resources">Advanced resources</button>
  </div>

  <!-- Logs -->
  <div id="allLogs" class="tab-content active">
    <p id="dateRangeNote" style="font-size:14px;color:#555;margin-bottom:10px;"></p>
    <div class="filters">
      <label><input type="checkbox" id="logsOnCampus"> On campus only</label>
    </div>
    <div class="table-container">
      <input type="text" id="searchAll" placeholder="Search logs..." autocomplete="off">
      <table id="logsTableAll"></table>
    </div>
    <button id="loadMoreAll">Load more</button>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="tab-content">
    <div class="filters">
      <label>From: <input type="date" id="chartStartDate"></label>
      <label>To: <input type="date" id="chartEndDate"></label>
      <label><input type="checkbox" id="dashboardOnCampus"> On campus only</label>
    </div>
    <div id="categoryChart"></div>
  </div>

  <!-- Advanced resources -->
  <div id="resources" class="tab-content">

    <h3 style="margin-top:20px;">Email Alerts Signup</h3>
    <form id="emailForm" style="margin-top:10px;">
      <input 
        type="email" 
        id="emailInput" 
        placeholder="Enter your email" 
        required 
        style="padding:8px; margin-bottom:10px; border:1px solid #ccc; border-radius:4px; width:250px;"
      ><br>

      <label><input type="checkbox" id="daily"> Daily report</label><br>
      <label><input type="checkbox" id="weekly"> Weekly report</label><br>
      <label><input type="checkbox" id="frat"> Weekly report (frat row)</label><br><br>

      <button 
        type="submit" 
        style="padding:8px 16px; background:#ac2124; color:#fff; border:none; border-radius:4px; cursor:pointer;"
      >
        Subscribe
      </button>
    </form>



    <script>

      // ================================
      // Email Alerts Form Submission (GET approach)
      // ================================
      document.addEventListener("DOMContentLoaded", function() {
        const form = document.getElementById("emailForm");
        if (!form) return;

        form.addEventListener("submit", function(e) {
          e.preventDefault();
          e.stopPropagation();

          const userEmail = document.getElementById("emailInput").value;
          const dailyChecked = document.getElementById("daily").checked;
          const weeklyChecked = document.getElementById("weekly").checked;
          const fratChecked = document.getElementById("frat").checked;

          const url = "https://script.google.com/macros/s/AKfycbwAkY-tMnqOl6sFfUa4V8hTs_sW0OI1ciDKhXLIH4pzCJlEh7BZ9eLKFqEcpPVE3kiGCg/exec" +
            "?email=" + encodeURIComponent(userEmail) +
            "&daily=" + dailyChecked +
            "&weekly=" + weeklyChecked +
            "&fratrow=" + fratChecked;

          fetch(url)
            .then(res => res.json())
            .then(data => {
              if (data.status === "success") {
                alert("✅ Signed up successfully!");
                form.reset();
              } else {
                alert("⚠️ Error: " + data.message);
              }
            })
            .catch(err => {
              alert("⚠️ Network error: " + err);
            });
        });
      });

    </script>


    <h3>Download Data</h3>
    <p>You can download the full dataset in different formats:</p>
    <button id="downloadCSV">Download CSV</button>
    <button id="downloadJSON">Download JSON</button>

    <h3 style="margin-top:20px;">Advanced Search Guide</h3>
    <ul>
      <li><b>in:(Column) "phrase"</b> → search only within a column (e.g. <code>in:(Offense) "Burglary"</code>)</li>
      <li><b>from:MM/DD/YYYY to MM/DD/YYYY</b> → filter by date reported</li>
      <li><b>after:MM/DD/YYYY</b> / <b>before:MM/DD/YYYY</b> → filter before/after a date</li>
      <li><b>and</b> / <b>or</b> → combine multiple search conditions</li>
      <li><b>"quoted text"</b> → exact phrase search</li>
      <li><b>word1 word2</b> → matches if either word appears (OR)</li>
    </ul>
  </div>

  <script>
    let logsData = [], filteredData = [], rowsShown = 0;
    const rowsPerPage = 50;

    // Tabs
    document.querySelectorAll(".tab-button").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(btn.dataset.tab).classList.add("active");
      });
    });

    // Utility: convert JSON → CSV
    function convertToCSV(data) {
      if (!data.length) return "";
      const headers = Object.keys(data[0]).join(",");
      const rows = data.map(row => 
        Object.values(row).map(val => `"${(val || "").toString().replace(/"/g, '""')}"`).join(",")
      );
      return [headers, ...rows].join("\n");
    }

    // Download CSV
    document.getElementById("downloadCSV").addEventListener("click", () => {
      const csv = convertToCSV(logsData);
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "usc_crime_logs.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Download JSON
    document.getElementById("downloadJSON").addEventListener("click", () => {
      const blob = new Blob([JSON.stringify(logsData, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "usc_crime_logs.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // -----------------------------
    // Utility functions
    // -----------------------------
    function parseReportedDate(str) {
      if (!str) return new Date(0);
      const match = str.match(/(\d{2})\/(\d{2})\/(\d{2})/);
      if (!match) return new Date(0);
      let [_, mm, dd, yy] = match;
      let year = parseInt(yy, 10);
      year += year < 50 ? 2000 : 1900;
      return new Date(year, parseInt(mm) - 1, parseInt(dd));
    }

    function updateDateRangeNote(data) {
      if (!data.length) {
        document.getElementById("dateRangeNote").textContent = "No data available.";
        return;
      }
      const dates = data.map(d => parseReportedDate(d["Date Reported"]));
      const minDate = new Date(Math.min(...dates));
      const maxDate = new Date(Math.max(...dates));
      document.getElementById("dateRangeNote").textContent =
        `Data is available from ${minDate.toLocaleDateString()} to ${maxDate.toLocaleDateString()}`;
    }

    async function loadLogs() {
      const response = await fetch("usc_crime_logs.json");
      logsData = await response.json();

      // Normalize whitespace
      logsData = logsData.map(d => {
        const cleaned = {};
        for (const key in d) {
          cleaned[key] = typeof d[key] === "string"
            ? d[key].replace(/\s+/g, " ").trim()
            : d[key];
        }
        return cleaned;
      });

      logsData.sort((a, b) => parseReportedDate(b["Date Reported"]) - parseReportedDate(a["Date Reported"]));
      filteredData = [...logsData];
      updateDateRangeNote(filteredData);
      rowsShown = 0;
      renderTable(true);

      const dates = logsData.map(d => parseReportedDate(d["Date Reported"]));
      const minDate = new Date(Math.min(...dates));
      const maxDate = new Date(Math.max(...dates));

      function toInputDateFormat(d) { return d.toISOString().split("T")[0]; }
      document.getElementById("chartStartDate").setAttribute("min", toInputDateFormat(minDate));
      document.getElementById("chartStartDate").setAttribute("max", toInputDateFormat(maxDate));
      document.getElementById("chartEndDate").setAttribute("min", toInputDateFormat(minDate));
      document.getElementById("chartEndDate").setAttribute("max", toInputDateFormat(maxDate));

      // Default: last 30 days from most recent reported date
      let end = maxDate;
      let start = new Date(end);
      start.setDate(end.getDate() - 30);

      if (start < minDate) start = minDate;

      document.getElementById("chartStartDate").value = toInputDateFormat(start);
      document.getElementById("chartEndDate").value = toInputDateFormat(end);

      buildDashboardChart(start, end);

      // Refresh chart whenever dates or campus filter change
      ["chartStartDate","chartEndDate","dashboardOnCampus"].forEach(id => {
        document.getElementById(id).addEventListener("change", () => {
          const start = parsePacificDate(document.getElementById("chartStartDate").value);
          const end = parsePacificDate(document.getElementById("chartEndDate").value);
          if (start && end) buildDashboardChart(start, end);
        });
      });
    }




   function renderTable(reset = false) {
    const table = document.getElementById("logsTableAll");
    if (reset) table.innerHTML = "";

    let displayData = [...filteredData];
    if (!displayData.length) {
      table.innerHTML = "<tr><td>No results found</td></tr>";
      document.getElementById("loadMoreAll").style.display = "none";
      return;
    }

    // Hide the URL column from the table
    const columns = Object.keys(displayData[0]).filter(col => col !== "URL");

    if (reset) {
      const thead = document.createElement("thead");
      const headRow = document.createElement("tr");
      columns.forEach(col => {
        const th = document.createElement("th");
        th.textContent = col;
        th.style.width = (100 / columns.length) + "%";
        headRow.appendChild(th);
      });
      thead.appendChild(headRow);
      table.appendChild(thead);
    }

    let tbody = table.querySelector("tbody");
    if (!tbody) {
      tbody = document.createElement("tbody");
      table.appendChild(tbody);
    }

    const end = Math.min(rowsShown + rowsPerPage, displayData.length);
    for (let i = rowsShown; i < end; i++) {
      const row = displayData[i];
      const tr = document.createElement("tr");

      columns.forEach(col => {
        const td = document.createElement("td");

        if (col === "Event #") {
          const url = row["URL"] || "";
          if (url) {
            const a = document.createElement("a");
            a.href = url;
            a.textContent = row[col] || "";
            a.target = "_blank";
            a.classList.add("event-link");
            td.appendChild(a);
          } else {
            td.textContent = row[col] || "";
          }
        } else {
          td.textContent = row[col] || "";
        }

        td.setAttribute("data-label", col);
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    }

    rowsShown = end;
    document.getElementById("loadMoreAll").style.display =
      rowsShown < displayData.length ? "block" : "none";
  }




    // Date helpers
    function parsePacificDate(val) {
      if (!val) return null;
      const [yyyy, mm, dd] = val.split("-").map(Number);
      return new Date(yyyy, mm - 1, dd);
    }
    function formatPacificDate(val) {
      const d = parsePacificDate(val);
      return `${d.getMonth() + 1}/${d.getDate()}/${d.getFullYear()}`;
    }

    // -----------------------------
    // 📊 Dashboard
    // -----------------------------
    const categoryQueries = {
      "Assault": 'in:(Offense) "ASSAULT -" or "ASSAULT-"',
      "Battery": 'in:(Offense) "BATTERY -" or "BATTERY-"',
      "Rape": 'in:(Offense) "SEX OFFENSE - Rape" or "SEX OFFENSE-Rape"',
      "Robbery": 'in:(Offense) "ROBBERY -" or "ROBBERY-"',
      "Burglary": 'in:(Offense) "BURGLARY -" or "BURGLARY-"',
      "Bike/Scooter/Skateboard Theft": 'in:(Offense) "MOTOR VEHICLE THEFT - Theft of Motorized Bicycle/Scooter" or "THEFT-PETTY - Theft Bicycle"',
      "Alcohol Overdose": 'in:(Final Incident) "Alcohol Overdose"',
      "Drug Overdose": 'in:(Final Incident) "Drug Overdose"',
      "Party Shut Down": 'in:(Final Incident) "Party/Event Shut Down"',
      "Frat Row Noise": 'in:(Location) "900 Block Of 28TH ST" or "800 Block Of 28TH ST" or "700 Block Of 28TH ST" or "600 Block Of 28TH ST" and in:(Final Incident) "Loud and Raucous Noise"'
    };

    
    function buildDashboardChart(start, end) {
      const campusChecked = document.getElementById("dashboardOnCampus").checked;

      const filtered = logsData.filter(d => {
        const dt = parseReportedDate(d["Date Reported"]);
        if (isNaN(dt) || dt < start || dt > end) return false;
        if (campusChecked && !(d["Location"] || "").toLowerCase().includes("on campus")) return false;
        return true;
      });

      const seriesData = [];
      for (const [label, query] of Object.entries(categoryQueries)) {
        const tokens = parseQuery(query);
        const count = filtered.filter(row => evaluateRow(row, tokens)).length;
        seriesData.push({ label, count, query });
      }

      const options = {
        chart: { 
          type: 'bar', 
          height: 400, 
          toolbar: { show: false }, 
          events: {
            dataPointSelection: function(event, chartContext, config) {
              const category = options.xaxis.categories[config.dataPointIndex];
              const query = categoryQueries[category];
              const fromDate = document.getElementById("chartStartDate").value;
              const toDate = document.getElementById("chartEndDate").value;

              let dateFilter = "";
              if (fromDate && toDate) {
                dateFilter = `from:(${formatPacificDate(fromDate)} to ${formatPacificDate(toDate)}) and `;
              }

              let campusFilter = "";
              if (document.getElementById("dashboardOnCampus").checked) {
                campusFilter = ' and in:(Location) "on campus"';
                document.getElementById("logsOnCampus").checked = true;
              } else {
                document.getElementById("logsOnCampus").checked = false;
              }

              const fullQuery = `${dateFilter}${query}${campusFilter}`.trim();
              console.log("Generated query:", fullQuery); // debug

              // Switch to All incidents tab
              document.querySelector('[data-tab="allLogs"]').click();
              const searchBox = document.getElementById("searchAll");
              searchBox.value = fullQuery;
              searchBox.dispatchEvent(new Event("input"));
            }
          }
        },
        plotOptions: { bar: { borderRadius: 3, columnWidth: '55%' } },
        dataLabels: { enabled: false },
        xaxis: { 
          categories: seriesData.map(d => d.label), 
          labels: { rotate: -30, style: { fontSize: '12px' } } 
        },
        colors: ["#ac2124"],
        series: [{ name: "Incidents", data: seriesData.map(d => d.count) }]
      };

      const chartDiv = document.querySelector("#categoryChart");
      chartDiv.innerHTML = "";
      new ApexCharts(chartDiv, options).render();
    }



   // -----------------------------
  // Query Parsing / Evaluation
  // -----------------------------
    function parseQuery(query) {
      return query.match(
        /from:\([^)]*\)|after:\d{1,2}\/\d{1,2}\/\d{4}|before:\d{1,2}\/\d{1,2}\/\d{4}|in:\([^)]+\)\s+"[^"]+"|in:\([^)]+\)\s+[^\s]+|"(.*?)"|and|or|[^\s]+/gi
      ) || [];
    }

    function evaluateRow(row, tokens) {
      let result = null;
      let currentOp = "AND";
      let lastColumn = null;

      // Track date validity separately
      let dateValid = true;

      for (let t of tokens) {
        const token = t.toLowerCase();
        if (token === "and") { currentOp = "AND"; continue; }
        if (token === "or") { currentOp = "OR"; continue; }

        let condition = false;

        if (token.startsWith("from:(")) {
          const m = token.match(/from:\((\d{1,2}\/\d{1,2}\/\d{4})\s+to\s+(\d{1,2}\/\d{1,2}\/\d{4})\)/i);
          if (m) {
            const start = new Date(m[1]);
            const end = new Date(m[2]);
            const dt = parseReportedDate(row["Date Reported"]);
            dateValid = dt >= start && dt <= end;
          }
          continue; // don’t mix into OR/AND logic
        }
        else if (token.startsWith("after:")) {
          const m = token.match(/after:(\d{1,2}\/\d{1,2}\/\d{4})/);
          if (m) {
            const dt = parseReportedDate(row["Date Reported"]);
            dateValid = dt > new Date(m[1]);
          }
          continue;
        }
        else if (token.startsWith("before:")) {
          const m = token.match(/before:(\d{1,2}\/\d{1,2}\/\d{4})/);
          if (m) {
            const dt = parseReportedDate(row["Date Reported"]);
            dateValid = dt < new Date(m[1]);
          }
          continue;
        }
        else if (token.startsWith("in:(")) {
          const m = token.match(/in:\(([^)]+)\)\s*(.+)/);
          if (m) {
            const col = m[1].trim().toLowerCase();
            lastColumn = colMap[col];
            condition = matchValue(row[lastColumn], m[2].trim());
          }
        }
        else if (lastColumn) {
          condition = matchValue(row[lastColumn], token);
        }
        else {
          condition = matchRow(row, token);
        }

        if (result === null) result = condition;
        else if (currentOp === "AND") result = result && condition;
        else if (currentOp === "OR") result = result || condition;
      }

      // Enforce date filter separately
      return dateValid && (result === null ? true : result);
    }



    function matchValue(cell, valString) {
      const cellVal = (cell || "").toLowerCase();
      if (valString.startsWith('"') && valString.endsWith('"')) {
        const val = valString.slice(1, -1).toLowerCase();
        return cellVal.includes(val);
      } else {
        const words = valString.split(/\s+/);
        return words.some(w => cellVal.includes(w.toLowerCase()));
      }
    }

    function matchRow(row, valString) {
      if (valString.startsWith('"') && valString.endsWith('"')) {
        const val = valString.slice(1, -1).toLowerCase();
        return Object.values(row).some(v => v && v.toString().toLowerCase().includes(val));
      } else {
        const words = valString.split(/\s+/);
        return words.some(w =>
          Object.values(row).some(v => v && v.toString().toLowerCase().includes(w.toLowerCase()))
        );
      }
    }

    const colMap = {
      "date reported": "Date Reported",
      "event #": "Event #",
      "case #": "Case #",
      "offense": "Offense",
      "initial incident": "Initial Incident",
      "final incident": "Final Incident",
      "date from": "Date From",
      "date to": "Date To",
      "location": "Location",
      "disposition": "Disposition"
    };

    // Search bar
    document.getElementById("searchAll").addEventListener("input", e => {
      const q = e.target.value.trim();
      if (!q) { filteredData = [...logsData]; renderTable(true); return; }

      const tokens = parseQuery(q);
      if (!tokens.some(t => /in:|and|or|from:|after:|before:/i.test(t))) {
        const words = q.toLowerCase().split(/\s+/);
        filteredData = logsData.filter(row =>
          words.some(w => Object.values(row).some(val => val && val.toString().toLowerCase().includes(w)))
        );
      } else {
        filteredData = logsData.filter(row => evaluateRow(row, tokens));
      }
      rowsShown = 0;
      renderTable(true);
    });

    // On campus checkbox
    function applyOnCampusFilter(checkboxId) {
      const box = document.getElementById("searchAll");
      let query = box.value.trim();
      const checked = document.getElementById(checkboxId).checked;

      if (checked) {
        if (!query.toLowerCase().includes('in:(location) "on campus"')) {
          query = query ? query + " and in:(Location) \"on campus\"" : 'in:(Location) "on campus"';
        }
      } else {
        query = query.replace(/\s*and\s*in:\(location\)\s*"on campus"/i, "");
        query = query.replace(/in:\(location\)\s*"on campus"\s*and\s*/i, "");
        query = query.replace(/in:\(location\)\s*"on campus"/i, "");
      }

      box.value = query.trim();
      box.dispatchEvent(new Event("input"));
    }

    document.getElementById("logsOnCampus").addEventListener("change", () => applyOnCampusFilter("logsOnCampus"));
    document.getElementById("loadMoreAll").addEventListener("click", () => renderTable(false));

    function getDefaultRange() {
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - 30);
      return { start, end };
    }

    loadLogs();
  </script>
</body>
</html>

