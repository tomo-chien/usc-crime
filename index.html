<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Crime</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; color: #222; background: #fff; }
    h1 { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
    h1 span { color: #ac2124; }
    h2.subheading { font-size: 14px; color: #555; margin-bottom: 20px; font-style: italic; }
    .tabs { margin-bottom: 15px; }
    .tab-button { padding: 10px 16px; margin-right: 5px; border: none; background: #ddd; cursor: pointer; border-radius: 6px 6px 0 0; }
    .tab-button.active { background: #ac2124; color: #fff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .filters { margin-bottom: 10px; }
    .filters label { margin-right: 15px; }
    input[type="date"] { padding: 6px; border: 1px solid #ccc; border-radius: 4px; margin-right: 5px; }
    .table-container { overflow-x: auto; max-width: 100%; }
    #searchAll {
      display: block;
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      margin: 0 0 10px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    table { border-collapse: collapse; width: 100%; font-size: 12px; table-layout: fixed; }
    thead { background-color: #ac2124; color: #fff; position: sticky; top: 0; z-index: 2; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: left; white-space: normal; word-wrap: break-word; overflow-wrap: break-word; }
    tr:nth-child(even) { background: #f9f9f9; }
    tbody tr:hover { background: #f1f1f1; }
    #loadMoreAll { display: block; margin: 20px auto; padding: 10px 18px; border: none; background: #ac2124; color: #fff; font-size: 14px; border-radius: 25px; cursor: pointer; }
    #loadMoreAll:hover { background: #800000; transform: scale(1.05); }
    #loadMoreAll:active { transform: scale(0.95); }
    #categoryChart { max-width: 800px; margin: 20px auto 0 auto; }
    #crimeHeadline { text-align: center; font-size: 30px; font-weight: 800; line-height: 1.35; margin: 24px auto;}
    #crimeHeadline span { color: inherit; }   /* override any old rule */
    #crimeHeadline .pct { color: #ac2124; font-weight: 900; }
    #crimeHeadline .trend-word { font-weight: 800; }
    #yoyTrendChart { max-width: 1300px; margin: 14px auto 0; }



    #categoryHeadline { text-align: center; font-size: 16px; font-weight: 700; margin: 10px auto 6px auto; }
    #dashFilters { display: flex; justify-content: center; gap: 14px; margin-bottom: 6px; }
    #dashFilters label { margin-right: 0; }

    #mcChart,#bikeChart,#partyChart{ max-width:800px; margin:10px auto 0; }


    /* Match main headline size/weight for all subheadlines */
    .subheadline { text-align: center; font-size: 28px; font-weight: 800; line-height: 1.35; margin: 24px auto 12px; }
    @media (max-width: 768px) { .subheadline { font-size: 20px; } }

    /* Any headline variable */
    .pct, .var { color: #ac2124; font-weight: 900; }


    .adv-help code {
      background: #f6f6f6; padding: 2px 6px; border-radius: 4px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 12px;
    }
    .paramlist, .examplelist { margin: 8px 0 16px 18px; }
    .paramlist li, .examplelist li { margin: 8px 0; }
    .adv-help .note { color:#666; font-size:12px; margin-left:6px; }
    .adv-help .notes { color:#555; font-size:13px; }





    @media (max-width: 768px) {
      #crimeHeadline { font-size: 20px; }
    }


    #trendChart { max-width: 800px; margin: 20px auto 0 auto; }

    /* Advanced resources */
    #resources button {
      margin: 5px 10px 10px 0;
      padding: 10px 16px;
      border: none;
      background: #ac2124;
      color: #fff;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
    }
    #resources button:hover { background: #800000; }




    /* Mobile cards */
    @media (max-width: 768px) {
      body { margin: 10px; font-size: 14px; overflow-x: hidden; }
      h1 { font-size: 20px; }
      .tab-button { flex: 1; font-size: 14px; padding: 8px; }
      table { font-size: 11px; width: 100%; max-width: 100%; border-collapse: separate; }
      table thead { display: none; }
      table, table tbody, table tr, table td { display: block; width: 100%; max-width: 100%; box-sizing: border-box; }
      table tr { margin-bottom: 16px; padding: 12px 14px; border-radius: 12px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.08); cursor:pointer; transition: all 0.3s ease; }
      table td { text-align: left; padding: 6px 0; border: none; font-size: 13px; }
      .extra-fields { max-height:0; overflow:hidden; transition:max-height 0.3s ease; }
      tr.expanded .extra-fields { max-height:500px; margin-top:10px; }


       /* Charts should scale fully to the container */
      #yoyTrendChart, #mcChart, #bikeChart, #partyChart {
        width: 100%;
        max-width: 100%;
      }

      /* ApexCharts SVG/canvas can shrink on mobile */
      .apexcharts-canvas, .apexcharts-svg, .apexcharts-inner {
        max-width: 100% !important;
        width: 100% !important;
      }

      /* Horizontal scrolling feels natural on iOS */
      .table-container {
        -webkit-overflow-scrolling: touch;
      }
     .tabs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .tab-button {
        width: 100%;
        border-radius: 10px;
      }

      /* Dashboard goes first and spans both columns */
      .tab-button[data-tab="dashboard"] {
        order: 1;
        grid-column: 1 / -1;
      }

      /* Other two go beneath, side by side */
      .tab-button[data-tab="allLogs"]   { order: 2; }
      .tab-button[data-tab="resources"] { order: 3; }
    }

  

  </style>

<meta name="viewport" content="width=device-width, initial-scale=1">

</head>
<body>
  <h1>Morning, <span>Trojan.</span></h1>
  <h2 class="subheading">Crime dashboard</h2>

  <div class="tabs">
    <button class="tab-button active" data-tab="dashboard">Dashboard</button>
    <button class="tab-button" data-tab="allLogs">All incidents</button>
    <button class="tab-button" data-tab="resources">Advanced resources</button>
  </div>

 
   <!-- Dashboard -->
  <div id="dashboard" class="tab-content active">


  <div id="yoyHeadline" class="subheadline"></div>
  <div id="yoyTrendChart"></div>


    <!-- MOST COMMON CRIME TYPES -->
    <div id="mcHeadline" class="subheadline"></div>
    <div id="mcChart"></div>

    <!-- BIKE/SCOOTER/SKATEBOARD THEFT -->
    <div id="bikeHeadline" class="subheadline"></div>
    <div id="bikeChart"></div>

    <!-- PARTIES -->
    <div id="partyHeadline" class="subheadline"></div>
    <div id="partyChart"></div>
  </div>



  <!-- Logs -->
  <div id="allLogs" class="tab-content">
    <p id="dateRangeNote" style="font-size:14px;color:#555;margin-bottom:10px;"></p>
    <div class="filters">
      <label><input type="checkbox" id="logsOnCampus"> On campus only</label>
    </div>
    <div class="table-container">
      <input type="text" id="searchAll" placeholder="Search logs..." autocomplete="off">
      <table id="logsTableAll"></table>
    </div>
    <button id="loadMoreAll">Load more</button>
  </div>


  <!-- Advanced resources -->

  <div id="resources" class="tab-content">
    <h3>Download Data</h3>
    <p>You can download the full dataset in different formats:</p>
    <button id="downloadCSV">Download CSV</button>
    <button id="downloadJSON">Download JSON</button>

    <hr style="margin:24px 0; border:none; border-top:1px solid #eee;">

    <h3>Advanced search functions</h3>
    <p>The search box in the "All incidents" tab supports powerful filters.</p>

    <div class="adv-help">
      <h4>Parameters</h4>
      <ul class="paramlist">
        <li>
          <strong>Exact phrase</strong>: wrap in quotes.<br>
          <code>"bike theft"</code>
        </li>
        <li>
          <strong>Column filter</strong>: <code>in:(Column) value</code> or <code>in:(Column) "exact phrase"</code><br>
          Columns: <code>Date Reported</code>, <code>Event #</code>, <code>Case #</code>, <code>Offense</code>, <code>Initial Incident</code>, <code>Final Incident</code>, <code>Date From</code>, <code>Date To</code>, <code>Location</code>, <code>Disposition</code>, <code>URL</code>
        </li>
        <li>
          <strong>Date range</strong> (uses <code>Date From</code>):<br>
          <code>from:(MM/DD/YYYY to MM/DD/YYYY)</code>
        </li>
        <li>
          <strong>Date after / before</strong> (uses <code>Date From</code>):<br>
          <code>after:MM/DD/YYYY</code> &nbsp; <code>before:MM/DD/YYYY</code>
        </li>
        <li>
          <strong>Logic</strong>: use <code>and</code> / <code>or</code> between terms.
        </li>
      </ul>

      <h4>Examples</h4>
      <ul class="examplelist">
        <li>
          All incidents on campus:<br>
          <code>in:(Location) "on campus"</code>
        </li>
        <li>
          Robberies in September 2024:<br>
          <code>in:(Offense) robbery and from:(09/01/2024 to 09/30/2024)</code>
        </li>
        <li>
          Noise complaints on frat row<br>
          <code>in:(Location) "900 Block Of 28TH ST" or "800 Block Of 28TH ST" or "700 Block Of 28TH ST" or "600 Block Of 28TH ST" and in:(Final Incident) "Loud and Raucous Noise"</code>
        </li>
      </ul>

      <p class="notes">
        Notes: searches are case-insensitive; phrases with spaces need quotes; column names must match exactly (as listed above).
      </p>
    </div>
  </div>

  <script>
    let logsData = [], filteredData = [], rowsShown = 0;
    const rowsPerPage = 50;

    // Tabs
    document.querySelectorAll(".tab-button").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(btn.dataset.tab).classList.add("active");
      });
    });
    // Utilities
    function parseFromDate(str) {
      if (!str) return new Date(0);
      const m = str.match(/(\d{2})\/(\d{2})\/(\d{2})/);
      if (!m) return new Date(0);
      let [_, mm, dd, yy] = m;
      let year = +yy < 50 ? 2000 + +yy : 1900 + +yy;
      return new Date(year, mm - 1, dd);
    }
    function formatPacificDate(val) {
      const d = new Date(val);
      return `${d.getMonth() + 1}/${d.getDate()}/${d.getFullYear()}`;
    }

    // Animate counters
    function animateValue(el, start, end, duration) {
      const range = end - start;
      if (range === 0) { el.textContent = end + "%"; return; }
      let startTime;
      function step(ts) {
        if (!startTime) startTime = ts;
        const progress = Math.min((ts - startTime) / duration, 1);
        el.textContent = Math.round(start + range * progress) + "%";
        if (progress < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    // latest "Date From" in the dataset
    function latestDateFrom(){
      const ds = logsData.map(d=>parseFromDate(d["Date From"])).filter(d=>!isNaN(d));
      return new Date(Math.max(...ds));
    }
    // last 30-day window based on latest Date From
    function last30(){
      const end = latestDateFrom();
      const start = new Date(end); start.setDate(start.getDate()-29);
      return {start,end};
    }
    // month helpers
    function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
    function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
    function addMonths(d,n){ return new Date(d.getFullYear(), d.getMonth()+n, 1); }
    function plural(n, one, many){ return n===1?one:many; }

    function monthLabel(ts){
      const d = new Date(ts);
      const last = latestDateFrom();
      const base = d.toLocaleString(undefined, { month: "short" });
      const isCur = d.getMonth() === last.getMonth() && d.getFullYear() === last.getFullYear();
      return isCur ? `${base} (MTD)` : base;
    }



    // MOST COMMON
    const mostCommonQueries = {
      "Assault": 'in:(Offense) "ASSAULT -" or "ASSAULT-"',
      "Battery": 'in:(Offense) "BATTERY -" or "BATTERY-"',
      "Rape": 'in:(Offense) "SEX OFFENSE - Rape" or "SEX OFFENSE-Rape"',
      "Robbery": 'in:(Offense) "ROBBERY -" or "ROBBERY-"',
      "Kidnapping": 'in:(Offense) "KIDNAPPING -"',

      "Theft": 'in:(Offense) "THEFT-PETTY -" or "THEFT-MOTOR VEHICLE -" or "THEFT-TRICK -" or "THEFT-GRAND -"',
      "Motor vehicle theft": 'in:(Offense) "MOTOR VEHICLE THEFT -"',

      "Burglary": 'in:(Offense) "BURGLARY -" or "BURGLARY-"',
      "Arson": 'in:(Offense) "ARSON -"',
      "Vandalism": 'in:(Offense) "VANDALISM -"',
      "Trespassing": 'in:(Offense) "TRESPASS -"'
    };

    // BIKE/SCOOTER/SKATEBOARD THEFT
    const bikeQuery = 'in:(Offense) "MOTOR VEHICLE THEFT - Theft of Motorized Bicycle/Scooter" or "THEFT-PETTY - Theft Bicycle"';

    // PARTIES & RELATED (last 30 days chart)
    const partyQueries = {
      "Party shut down": 'in:(Final Incident) "Party/Event Shut Down"',
      "Noise complaint": 'in:(Final Incident) "Loud and Raucous Noise"',
      "Alcohol Overdose": 'in:(Final Incident) "Alcohol Overdose"',
      "Drug Overdose": 'in:(Final Incident) "Drug Overdose"'
    };



    // Query parsing + row evaluation
    function parseQuery(query) {
      return query.match(/from:\(\d{1,2}\/\d{1,2}\/\d{4}\s+to\s+\d{1,2}\/\d{1,2}\/\d{4}\)|after:\d{1,2}\/\d{1,2}\/\d{4}|before:\d{1,2}\/\d{1,2}\/\d{4}|in:\([^)]+\)\s+"[^"]+"|in:\([^)]+\)\s+[^\s]+|"(.*?)"|and|or|[^\s]+/gi) || [];
    }

    function evaluateRow(row, tokens) {
      let result = null, currentOp = "AND", lastColumn = null;
      for (let t of tokens) {
        const token = t.toLowerCase();
        if (token==="and"){currentOp="AND";continue;}
        if (token==="or"){currentOp="OR";continue;}
        let condition=false;
        if (token.startsWith("from:(")) {
          const m=token.match(/from:\((\d{1,2}\/\d{1,2}\/\d{4})\s+to\s+(\d{1,2}\/\d{1,2}\/\d{4})\)/);
          if(m){const start=new Date(m[1]), end=new Date(m[2]), dt=parseFromDate(row["Date From"]); condition=dt>=start&&dt<=end;}
        } else if(token.startsWith("after:")) {
          const m=token.match(/after:(\d{1,2}\/\d{1,2}\/\d{4})/); if(m){const dt=parseFromDate(row["Date From"]); condition=dt>new Date(m[1]);}
        } else if(token.startsWith("before:")) {
          const m=token.match(/before:(\d{1,2}\/\d{1,2}\/\d{4})/); if(m){const dt=parseFromDate(row["Date From"]); condition=dt<new Date(m[1]);}
        } else if(token.startsWith("in:(")) {
          const m=token.match(/in:\(([^)]+)\)\s*(.+)/); if(m){const col=m[1].trim().toLowerCase(); lastColumn=colMap[col]; condition=matchValue(row[lastColumn],m[2].trim());}
        } else if(lastColumn){condition=matchValue(row[lastColumn],token);}
        else{condition=matchRow(row,token);}
        if(result===null)result=condition; else if(currentOp==="AND")result=result&&condition; else if(currentOp==="OR")result=result||condition;
      }
      return result===null?false:result;
    }

    function matchValue(cell,valString){
      const cellVal=(cell||"").toLowerCase();
      if(valString.startsWith('"')&&valString.endsWith('"')){
        const val=valString.slice(1,-1).toLowerCase();
        return cellVal.includes(val);
      } else {
        const words=valString.split(/\s+/);
        return words.some(w=>cellVal.includes(w.toLowerCase()));
      }
    }

    function matchRow(row,valString){
      if(valString.startsWith('"')&&valString.endsWith('"')){
        const val=valString.slice(1,-1).toLowerCase();
        return Object.values(row).some(v=>v&&v.toString().toLowerCase().includes(val));
      } else {
        const words=valString.split(/\s+/);
        return words.some(w=>Object.values(row).some(v=>v&&v.toString().toLowerCase().includes(w.toLowerCase())));
      }
    }

    const colMap = {
      "date reported":"Date Reported",
      "event #":"Event #",
      "case #":"Case #",
      "offense":"Offense",
      "initial incident":"Initial Incident",
      "final incident":"Final Incident",
      "date from":"Date From",
      "date to":"Date To",
      "location":"Location",
      "disposition":"Disposition",
      "url":"URL"
    };
    // Render table (desktop + mobile)
    function renderTable(reset=false) {
      const table=document.getElementById("logsTableAll"); 
      if(reset)table.innerHTML="";
      let displayData=[...filteredData];
      if(!displayData.length){
        table.innerHTML="<tr><td>No results found</td></tr>";
        document.getElementById("loadMoreAll").style.display="none";
        return;
      }

      const columns=Object.keys(displayData[0]);
      if(reset){
        const thead=document.createElement("thead");
        const headRow=document.createElement("tr");
        columns.forEach(col=>{
          if(col==="URL")return;
          const th=document.createElement("th");
          th.textContent=col;
          th.style.width=(100/columns.length)+"%";
          headRow.appendChild(th);
        });
        thead.appendChild(headRow);
        table.appendChild(thead);
      }

      let tbody=table.querySelector("tbody"); 
      if(!tbody){tbody=document.createElement("tbody");table.appendChild(tbody);}
      const end=Math.min(rowsShown+rowsPerPage,displayData.length);

      for(let i=rowsShown;i<end;i++){
        const row=displayData[i];
        const tr=document.createElement("tr");

        if(window.innerWidth<=768){
          // Mobile summary
          const summaryFields=["Date Reported","Final Incident","Location"];
          summaryFields.forEach(col=>{
            const td=document.createElement("td");
            td.textContent=row[col]||"";
            tr.appendChild(td);
          });

          const extra=document.createElement("div");
          extra.classList.add("extra-fields");
          Object.keys(row).forEach(col=>{
            if(summaryFields.includes(col)||col==="URL")return;
            const div=document.createElement("div");
            div.textContent=col+": "+(row[col]||"");
            extra.appendChild(div);
          });
          tr.appendChild(extra);

          tr.addEventListener("click",()=>{tr.classList.toggle("expanded");});

        } else {
          // Desktop
          Object.keys(row).forEach(col=>{
            if(col==="URL")return;
            const td=document.createElement("td");
            if(col==="Event #"&&row["URL"]){
              const a=document.createElement("a");
              a.href=row["URL"];
              a.textContent=row[col]||"";
              a.style.color="#ac2124";
              a.target="_blank";
              td.appendChild(a);
            } else {
              td.textContent=row[col]||"";
            }
            td.setAttribute("data-label",col);
            tr.appendChild(td);
          });
        }
        tbody.appendChild(tr);
      }

      rowsShown=end;
      document.getElementById("loadMoreAll").style.display=rowsShown<displayData.length?"block":"none";
    }

async function loadLogs() {
  const response = await fetch("usc_crime_logs.json");
  logsData = await response.json();

  // Clean whitespace
  logsData = logsData.map(d => {
    const cleaned = {};
    for (const k in d) cleaned[k] = typeof d[k] === "string" ? d[k].replace(/\s+/g, " ").trim() : d[k];
    return cleaned;
  });

  // Sort newest first by Date From
  logsData.sort((a,b) => parseFromDate(b["Date From"]) - parseFromDate(a["Date From"]));

  // Table
  filteredData = [...logsData];
  updateDateRangeNote(filteredData);
  rowsShown = 0;
  renderTable(true);

  // --- DASHBOARD MODULES ---
  buildYoYTrendChart();
  buildMostCommonChart();     // all-time most common types
  buildBikeTheftChart();      // 12-month line + last-30 headline
  buildPartiesChart();        // last-30 bars + headline
}


    // Update incidents tab note
    function updateDateRangeNote(data){
      const dates = data
        .map(d => parseFromDate(d["Date Reported"]))
        .filter(d => !isNaN(d));
      if (!dates.length) {
        document.getElementById("dateRangeNote").textContent = "No data available.";
        return;
      }
      const minDate = new Date(Math.min(...dates));
      const maxDate = new Date(Math.max(...dates));
      document.getElementById("dateRangeNote").textContent =
        `Data available from ${minDate.toLocaleDateString()} to ${maxDate.toLocaleDateString()}`;
    }

    function plural(n, one, many) {
      return n === 1 ? one : many;
    }





    // Dashboard listeners
    ["chartStartDate","chartEndDate"].forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener("change",()=>{
        const start=new Date(document.getElementById("chartStartDate").value);
        const end=new Date(document.getElementById("chartEndDate").value);
        if(!isNaN(start) && !isNaN(end)) buildDashboardChart(start,end);
      });
    });

    // Search box
    document.getElementById("searchAll").addEventListener("input",e=>{
      const q=e.target.value.trim();
      if(!q){
        filteredData=[...logsData];
        renderTable(true);
        return;
      }
      const tokens=parseQuery(q);
      if(!tokens.some(t=>/in:|and|or|from:|after:|before:/i.test(t))){
        const words=q.toLowerCase().split(/\s+/);
        filteredData=logsData.filter(row=>
          words.some(w=>Object.values(row).some(val=>val&&val.toString().toLowerCase().includes(w)))
        );
      } else {
        filteredData=logsData.filter(row=>evaluateRow(row,tokens));
      }
      rowsShown=0;
      renderTable(true);
    });

    // On-campus filter
    function applyOnCampusFilter(checkboxId){
      const box=document.getElementById("searchAll");
      let query=box.value.trim();
      const checked=document.getElementById(checkboxId).checked;
      if(checked){
        if(!query.toLowerCase().includes('in:(location) "on campus"')){
          query=query ? query+' and in:(Location) "on campus"' : 'in:(Location) "on campus"';
        }
      } else {
        query=query.replace(/\s*and\s*in:\(location\)\s*"on campus"/i,"");
        query=query.replace(/in:\(location\)\s*"on campus"\s*and\s*/i,"");
        query=query.replace(/in:\(location\)\s*"on campus"/i,"");
      }
      box.value=query.trim();
      box.dispatchEvent(new Event("input"));
    }
    document.getElementById("logsOnCampus").addEventListener("change",()=>applyOnCampusFilter("logsOnCampus"));
    document.getElementById("loadMoreAll").addEventListener("click",()=>renderTable(false));



function buildMostCommonChart() {
  const container = document.getElementById("mcChart");
  const headlineEl = document.getElementById("mcHeadline");
  if (!container || !headlineEl) return;
  if (!logsData || !logsData.length) {
    headlineEl.textContent = "No data available.";
    container.innerHTML = "";
    return;
  }

  // local helper: lowercase first letter
  const lcFirst = s => (s ? s.charAt(0).toLowerCase() + s.slice(1) : s);

  // last 30 days based on latest "Date From" (uses your existing last30())
  const { start, end } = last30();

  // violent categories use yellow
  const violent = new Set(["Assault", "Battery", "Rape", "Robbery", "Kidnapping"]);

  // Build counts for the last 30 days only
  const labels = Object.keys(mostCommonQueries);
  const counts = labels.map(label => {
    const tokens = parseQuery(mostCommonQueries[label]);
    return logsData.filter(row => {
      const dt = parseFromDate(row["Date From"]);
      return !isNaN(dt) && dt >= start && dt <= end && evaluateRow(row, tokens);
    }).length;
  });

  // Headline: most common category (lowercase first letter), handle ties simply
  const max = Math.max(...counts);
  const leaders = labels.filter((_, i) => counts[i] === max);
  const leaderText = lcFirst(leaders[0]) + (leaders.length > 1 ? " (tie)" : "");
  headlineEl.innerHTML = `In the last 30 days, the most common crime was <span class="pct">${leaderText}</span>.`;

  // Colors per bar (violent = yellow, else red)
  const colors = labels.map(l => (violent.has(l) ? "#FFCC00" : "#ac2124"));

  // Render bar chart (no legend, distributed colors)
  container.innerHTML = "";
  new ApexCharts(container, {
    chart: { type: "bar", height: 320, toolbar: { show: false } },
    legend: { show: false },
    plotOptions: { bar: { borderRadius: 3, columnWidth: "55%", distributed: true } },
    dataLabels: { enabled: false },
    xaxis: { categories: labels, labels: { rotate: -30, style: { fontSize: "12px" } } },
    yaxis: { min: 0, forceNiceScale: true, title: { text: "# of incidents (last 30 days)" } },
    series: [{ name: "Incidents", data: counts }],
    colors
  }).render();
}


function buildBikeTheftChart(){
  if (!logsData?.length) return;

  const startOfMonth = d => new Date(d.getFullYear(), d.getMonth(), 1);
  const endOfMonth   = d => new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999);
  const addMonths    = (d,n) => new Date(d.getFullYear(), d.getMonth()+n, 1);
  const inRange      = (dt,s,e) => !isNaN(dt) && dt >= s && dt <= e;

  const latest = latestDateFrom();
  const start30 = new Date(latest); start30.setDate(start30.getDate()-29);

  const bikeTok = parseQuery(
    'in:(Offense) "MOTOR VEHICLE THEFT - Theft of Motorized Bicycle/Scooter" or "THEFT-PETTY - Theft Bicycle"'
  );

  // Headline
  const last30Count = logsData.filter(r=>{
    const dt = parseFromDate(r["Date From"]);
    return inRange(dt, start30, latest) && evaluateRow(r, bikeTok);
  }).length;
  document.getElementById("bikeHeadline").innerHTML =
    `There were <span class="pct">${last30Count}</span> bikes, scooters, and skateboards reported stolen.`;

  // Monthly counts
  const curMonth   = startOfMonth(latest);
  const firstMonth = addMonths(curMonth, -11);
  const months     = [];
  for (let m = new Date(firstMonth); m <= curMonth; m = addMonths(m,1)) months.push(new Date(m));

  const monthlyCounts = months.map(m=>{
    const ms = startOfMonth(m), me = endOfMonth(m);
    return logsData.reduce((acc,row)=>{
      const dt = parseFromDate(row["Date From"]);
      return acc + (inRange(dt, ms, me) && evaluateRow(row, bikeTok) ? 1 : 0);
    }, 0);
  });

  const isPartialMonth = latest < endOfMonth(curMonth);

  const categories = months.map(m=>{
    const base = m.toLocaleString(undefined,{month:"short"});
    return (m.getMonth()===curMonth.getMonth() && m.getFullYear()===curMonth.getFullYear() && isPartialMonth)
      ? `${base} (MTD)` : base;
  });

  // Break the base series and create a transparent overlay for the final segment
  const baseSeries = monthlyCounts.slice();
  const overlaySeries = new Array(monthlyCounts.length).fill(null);

  if (isPartialMonth && monthlyCounts.length >= 2) {
    // remove the final point from the base so the last segment isn't drawn at full opacity
    baseSeries[baseSeries.length - 1] = null;
    // overlay only the connecting segment
    overlaySeries[overlaySeries.length - 2] = monthlyCounts[monthlyCounts.length - 2];
    overlaySeries[overlaySeries.length - 1] = monthlyCounts[monthlyCounts.length - 1];
  }

  const el = document.getElementById("bikeChart");
  el.innerHTML = "";

  const series = [{ name:"Thefts", data: baseSeries }];
  if (isPartialMonth) {
    series.push({
      name: "Thefts (MTD)",
      data: overlaySeries,
      color: "rgba(172,33,36,0.4)", // same hue, more transparent
      stroke: { width: 3, curve: "smooth" },
      markers: { size: 3, colors: "rgba(172,33,36,0.4)", strokeColors: "rgba(172,33,36,0.4)" }
    });
  }

  new ApexCharts(el, {
    chart:{ type:"line", height:320, toolbar:{show:false}, zoom:{enabled:false} },
    stroke:{ width:3, curve:"smooth" },
    markers:{ size:3 },
    series,
    colors: ["#ac2124", "rgba(172,33,36,0.4)"],
    xaxis:{
      type:"category",
      categories,
      tickPlacement:"on",
      labels:{ rotate:-30, style:{ fontSize:"12px" } },
      tooltip:{ enabled:false }
    },
    yaxis:{ min:0, forceNiceScale:true, title:{ text:"# of incidents" } },
    legend:{ show:false }
  }).render();
}





function buildPartiesChart(){
  const {start,end} = last30();

  const labels = Object.keys(partyQueries);
  const counts = labels.map(label=>{
    const tokens = parseQuery(partyQueries[label]);
    return logsData.filter(r=>{
      const dt = parseFromDate(r["Date From"]);
      return !isNaN(dt) && dt>=start && dt<=end && evaluateRow(r,tokens);
    }).length;
  });

  const shutDown = counts[labels.indexOf("Party shut down")] || 0;
  const noise = counts[labels.indexOf("Noise complaint")] || 0;

  document.getElementById("partyHeadline").innerHTML =
    `DPS shut down <span class="pct">${shutDown}</span> ${plural(shutDown,"party","parties")} and logged <span class="pct">${noise}</span> ${plural(noise,"noise complaint","noise complaints")}.`;


  new ApexCharts(document.getElementById("partyChart"), {
    chart:{ type:"bar", height:320, toolbar:{show:false} },
    plotOptions:{ bar:{ borderRadius:3, columnWidth:"55%" } },
    dataLabels:{ enabled:false },
    xaxis:{ categories:labels, labels:{ rotate:-15, style:{fontSize:"12px"} } },
    yaxis:{ min:0, forceNiceScale:true, title:{ text:"# of incidents (last 30 days)" } },
    colors:["#ac2124"],
    series:[{ name:"Incidents", data:counts }]
  }).render();
}


function buildYoYTrendChart() {
  const headlineEl = document.getElementById("yoyHeadline");
  const chartEl = document.getElementById("yoyTrendChart");
  if (!headlineEl || !chartEl) return;
  if (!logsData || !logsData.length) {
    headlineEl.textContent = "No data available.";
    chartEl.innerHTML = "";
    return;
  }

  const toStartOfDay = d => new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const addDays = (d, n) => { const x = new Date(d); x.setDate(x.getDate() + n); return x; };
  const weekStart = d => { const s = toStartOfDay(d); s.setDate(s.getDate() - s.getDay()); return s; };
  const inRange = (dt, s, e) => !isNaN(dt) && dt >= s && dt <= e;

  const monthLabel = (ts) => {
    const d = new Date(ts);
    const last = latestDateFrom();
    const base = d.toLocaleString(undefined, { month: "short" });
    return (d.getMonth() === last.getMonth() && d.getFullYear() === last.getFullYear())
      ? `${base} (MTD)` : base;
  };

  const propTokens = parseQuery('in:(Offense) "theft" or "burglary" or "arson" or "vandalism" or "trespass"');
  const violTokens = parseQuery('in:(Offense) "robbery" or "assault" or "battery" or "rape" or "murder" or "homicide" or "kidnapping" or "carjacking"');
  const isReported = r => evaluateRow(r, propTokens) || evaluateRow(r, violTokens);

  const endCurr = latestDateFrom();
  const startCurr = addDays(endCurr, -29);
  const startPrev = new Date(startCurr); startPrev.setFullYear(startPrev.getFullYear() - 1);
  const endPrev   = new Date(endCurr);   endPrev.setFullYear(endPrev.getFullYear() - 1);

  const currTotal = logsData.filter(r => inRange(parseFromDate(r["Date From"]), startCurr, endCurr) && isReported(r)).length;
  const prevTotal = logsData.filter(r => inRange(parseFromDate(r["Date From"]), startPrev, endPrev) && isReported(r)).length;

  if (prevTotal < 1) {
    headlineEl.textContent = "Not enough data for a year-over-year comparison.";
  } else {
    const pct = Math.round(((currTotal - prevTotal) / prevTotal) * 100);
    const word = (pct >= 0) ? "up" : "down";
    headlineEl.innerHTML =
      `Reported crimes are <span class="trend-word">${word}</span> <span class="pct"><span>${Math.abs(pct)}</span>%</span> compared to this time last year.`;
  }

  const firstMonth = new Date(endCurr.getFullYear(), endCurr.getMonth() - 15, 1);
  const firstWeekStart = weekStart(firstMonth);
  const lastWeekStart  = weekStart(endCurr);

  const weeks = [];
  for (let ws = new Date(firstWeekStart); ws <= lastWeekStart; ws = addDays(ws, 7)) {
    weeks.push({ ws, we: addDays(ws, 6) });
  }

  const propSeries = [];
  const violSeries = [];
  weeks.forEach(({ ws, we }) => {
    let p = 0, v = 0;
    logsData.forEach(row => {
      const dt = parseFromDate(row["Date From"]);
      if (!inRange(dt, ws, we)) return;
      if (evaluateRow(row, propTokens)) p++;
      else if (evaluateRow(row, violTokens)) v++;
    });
    const x = ws.getTime();
    propSeries.push({ x, y: p });
    violSeries.push({ x, y: v });
  });

  const bandColor = "#ac2124";
  const annotations = {
    position: "front",
    xaxis: [
      {
        x: startCurr.getTime(),
        x2: endCurr.getTime(),
        fillColor: bandColor,
        opacity: 0.25,
        borderColor: bandColor,
        borderWidth: 2,
        label: { text: "Last 30 days", style: { color: "#000", fontSize: "11px", background: "#fff",
                 padding: { left: 6, right: 6, top: 2, bottom: 2 } } }
      },
      {
        x: startPrev.getTime(),
        x2: endPrev.getTime(),
        fillColor: bandColor,
        opacity: 0.12,
        borderColor: bandColor,
        borderWidth: 2
      }
    ]
  };

  // determine if the *last week* is incomplete (week-to-date)
  const lastWeekEnd = addDays(lastWeekStart, 6);
  const isPartialWeek = endCurr < lastWeekEnd;

  // if incomplete, lower the fill opacity for just that final bar
  if (isPartialWeek && weeks.length) {
    const lastIdx = weeks.length - 1;
    propSeries[lastIdx] = { ...propSeries[lastIdx], fillColor: "rgba(172,33,36,0.5)" };
    violSeries[lastIdx] = { ...violSeries[lastIdx], fillColor: "rgba(255,204,0,0.5)" };
  }

  chartEl.innerHTML = "";
  new ApexCharts(chartEl, {
    chart: { type: "bar", height: 340, stacked: true, toolbar: { show: false }, zoom: { enabled: false } },
    series: [
      { name: "Property", data: propSeries },
      { name: "Violent",  data: violSeries }
    ],
    colors: ["#ac2124", "#FFCC00"],
    plotOptions: { bar: { columnWidth: "65%", borderRadius: 2 } },
    dataLabels: { enabled: false },
    xaxis: {
      type: "datetime",
      min: firstWeekStart.getTime(),
      max: addDays(lastWeekStart, 6).getTime(),
      tickAmount: 16,
      tickPlacement: "on",
      labels: {
        formatter: monthLabel,
        style: { fontSize: "12px" }
      },
      tooltip: { enabled: false }
    },
    yaxis: { min: 0, forceNiceScale: true, title: { text: "# of incidents" } },
    legend: { position: "top" },
    tooltip: {
      shared: true,
      intersect: false,
      x: {
        formatter: (val) => {
          const s = new Date(val), e = addDays(s, 6);
          const fmt = d => d.toLocaleDateString(undefined, { month: "short", day: "numeric" });
          return `Week of ${fmt(s)} â€“ ${fmt(e)}`;
        }
      }
    },
    annotations
  }).render();
}


function triggerDownloadFromBlob(blob, filename) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

async function downloadFile(path, filename, mime) {
  try {
    // Build an absolute URL and bypass cache so you get the freshest Action-updated file
    const url = new URL(path, window.location.href).toString();
    const res = await fetch(url + (url.includes('?') ? '&' : '?') + '_=' + Date.now(), { cache: 'no-store' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const blob = await res.blob();

    // If server didn't send a type, force one
    const typedBlob = blob.type ? blob : new Blob([blob], { type: mime });
    triggerDownloadFromBlob(typedBlob, filename);
  } catch (err) {
    console.error('Download failed:', err);
    // Fallback: navigate to the file (lets the browser handle it)
    window.location.href = path;
  }
}

// ---- Wire up the buttons ----
const btnCSV = document.getElementById('downloadCSV');
const btnJSON = document.getElementById('downloadJSON');

if (btnCSV) {
  btnCSV.addEventListener('click', () =>
    downloadFile('usc_crime_logs.csv', 'usc_crime_logs.csv', 'text/csv;charset=utf-8')
  );
}
if (btnJSON) {
  btnJSON.addEventListener('click', () =>
    downloadFile('usc_crime_logs.json', 'usc_crime_logs.json', 'application/json;charset=utf-8')
  );
}




    // Init
    loadLogs();
  </script>


</body>
</html>
